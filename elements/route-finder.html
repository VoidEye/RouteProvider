<!DOCTYPE html>
<html>
<head>
	<link href="../bower_components/polymer/polymer.html" rel="import">
	<link href="../bower_components/paper-drawer-panel/paper-drawer-panel.html" rel="import">
	<link href="../bower_components/paper-header-panel/paper-header-panel.html" rel="import">
	<link href="../bower_components/paper-toolbar/paper-toolbar.html" rel="import">
	<link href="../bower_components/paper-icon-button/paper-icon-button.html" rel="import">
	<link href="../bower_components/paper-material/paper-material.html" rel="import">
	<link href="../bower_components/paper-menu/paper-menu.html" rel="import">	
	<link href="../bower_components/paper-item/paper-item.html" rel="import">
	<link href="../bower_components/paper-input/paper-input.html" rel="import">
	<link href="../bower_components/paper-fab/paper-fab.html" rel="import">
	<link href="../bower_components/paper-button/paper-button.html" rel="import">
	<link href="../bower_components/iron-icons/iron-icons.html" rel="import">
	<link href="../bower_components/leaflet-map/leaflet-map.html" rel="import">
	<link href="../bower_components/paper-radio-group/paper-radio-group.html" rel="import">
	<link href="../bower_components/paper-radio-button/paper-radio-button.html" rel="import">

	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

	<link rel="stylesheet" href="../leaflet/leaflet.css" />
	<script src="../leaflet/leaflet.js"></script>
	<script src="../leaflet/leaflet-src.js"></script>

	<link rel="stylesheet" href="../ControlGeoCoder/Control.Geocoder.css" />
	<script src="../ControlGeoCoder/Control.Geocoder.js"></script>

	<link rel="stylesheet" href="../leaflet-search/leaflet-search.css" />
	<script src="../leaflet-search/leaflet-search.js"></script>

</head>

<dom-module id="route-finder">
	<style>
	#DirectionsEntry {
		margin-top: 15px;
		padding-top: 50px;
		max-width: 180px;
		max-height: 200px;
	}
	#JourneyOptions {
		width: 120px;
		margin-top: 30px;
	}
	#hourPicker, #minutePicker{
		width: 25px;
	}
	#datePicker{
		width: 75px;
		margin-top: 15px;
	}
	#getToday{
		background-color: 5059FF;
		font-size: 12px;
		margin-top: 5px;
	}
	#swap{
		background-color: 5059FF;
		max-width: 10px;
		font-size: 10px;
		margin-top: 5px;
	}
	.main-panel {
		background-color: #eee;
		height: 100vh;
		overflow-y: hidden;
	}
	#mainButton{
		margin-top: 40px;
		width: 40;
		height: 30px;
	}
	#internal{
		width:180px;
	}
	#maxWalk{
		width: 55px;
	}
	paper-radio-group  > * {
  		padding: 3px;
	}
	paper-radio-button {
    	white-space: nowrap;
    	cursor: pointer;
	}
	paper-material {
		background-color: #fff;
		max-width: 640px;
		width: 95%;
		margin: 25px auto;
		position: relative;
	}
	paper-toolbar {
		color: black;
		background: #C7EDFF;
		float: left;
		width: 100%;
    	height: 150px;
	}
	paper-input.route-finder {
    	height: 40;
    	margin-bottom: 5px;
    	max-width: 140px;
	}
	paper-input{
		max-width: 140px;
	}
	paper-header-panel{
		height: 151px;
	}
	paper-drawer-panel{
		height: 100%;
		position: relative;
		--paper-drawer-panel-main-container: {
    		background-color: C7EDFF;
    	};
    	--paper-drawer-panel-left-drawer-container: {
    		background-color: #91DBFF;
  		};
	}
	</style>
  
	<template>
		<paper-header-panel>
			<paper-toolbar elevation="2">
				<div id="DirectionsEntry" class="top">
					<paper-input id="inputStart" label="From" value="Newelska 6"></paper-input>
					<paper-input id="inputStop" label="To" value="Opaczewska 34"></paper-input>
					<input type="text" id="datePicker">
					<input type="text" id="hourPicker">:<input type="text" id="minutePicker">
					<paper-radio-group selected="Departure" id="selection">
						<paper-radio-button name="Departure">Odjazd</paper-radio-button>
						<paper-radio-button name="Arrival">Przyjazd</paper-radio-button>
					</paper-radio-group>
				</div>
				<div id="JourneyOptions">
					<paper-fab id="mainButton" icon="icons:reply" on-click="forwardRequest"></paper-fab>
					<div id ="internal">
						<paper-button raised id="swap" on-click="swapStartStop"><></paper-button>
						<paper-button raised id="getToday" on-click="setCurrentDate">Now</paper-button>
					</div>
					Trasa piechotą:
					<input type="text" id="maxWalk">
				</div>
			</paper-toolbar>
		</paper-header-panel>
		<paper-drawer-panel>
			<div drawer>
			</div>
			<div main>
				<leaflet-map id="warsawMap" latitude="52.2297" longitude="21.0122" zoom="12">
				</leaflet-map>
			</div>
		</paper-drawer-panel> 
	</template>


<script>
  Polymer({
    is: "route-finder",

    properties: {
    	startPointSet: {
    		type: Boolean,
    		value: true
    	}
    },

    forwardRequest: function(){
    	//Dać możliwość wprowadzania koordynatorów zamiast nazw, tylok jeżeli będzie poza jakimśzakresem, to wyrzucać wyjatek, albo mieć to w dupie i czekać aż OTP nie znajdzie połączenia.
    	var geocoder = new L.Control.Geocoder.Nominatim();
    	var startAdress = this.$.inputStart.value;
    	var stopAdress = this.$.inputStop.value;

    	var functionInkoevd = 0,
			latLngStart,
			latLngStop,
			startName,
	 		stopName,
    		startPointCoords,
	 		stopPointCoords,
	 		bStart = false,
	 		bStop = false;

	 	if (/[a-z]/i.test(startAdress) === true){
	 		bStart = true;
    		geocoder.geocode(startAdress, getCoords);
    	}
    	else{
    		bStart = true;
    		var cordsArr = startAdress.split(",");
    		var toPass = [];
    			toPass[0] = {
    			name: "",
    			center: L.latLng(cordsArr[0], cordsArr[1])
    		}
    		getCoords(toPass);
    	}	
    	if (/[a-z]/i.test(stopAdress) === true){
    		bStop = true;
	 		geocoder.geocode(stopAdress, getCoords);
	 	}
	 	else{
	 		bStop = true;
	 		var cordsArr = stopAdress.split(",");
    		var toPass = [];
    		toPass[0] = {
    			name: "",
    			center: L.latLng(cordsArr[0], cordsArr[1])
    		}
    		getCoords(toPass);
	 	}

	 	function getCoords(results){
	 		++functionInkoevd;
	 		if(bStart === true){
	 			bStart = false;    
       			latLngStart = new L.LatLng(results[0].center.lat, results[0].center.lng);
       			startName = results[0].name;
       			startPointCoords = {coords:latLngStart, stopName:name};
			}
			if(bStop === true){
				bStop = false;
				latLngStop = new L.LatLng(results[0].center.lat, results[0].center.lng);
       			stopName = results[0].name;
       			stopPointCoords = {coords:latLngStop, stopName:name};
			}
			if(functionInkoevd === 2)
			{
				var start_stop = [startPointCoords, stopPointCoords];
				console.log(start_stop);
       			functionInkoevd = 0;
				accumulateCoords(start_stop);
			}
       		
		}   	
    },
    setCurrentDate: function(){
    	setDate();
    },
    swapStartStop: function(){
    	var tmp = this.$.inputStart.value;
    	this.$.inputStart.value = this.$.inputStop.value;
		this.$.inputStop.value = tmp;
    },
	ready: function(e){
		this.addEventListener('complete', this.handleComplete);
		//console.log(this.present);
		this.addEventListener('presence', presChange);

		function presChange(e){
			var pres = this.present.pop()
			this.$.here.innerHTML = pres.occupancy;
		}
		window.onresize = function(event) {
		};
		window.onresize();
	},
  });

  $(function(){
    $("#datePicker").datepicker({
    	showButtonPanel: true,
   		dateFormat: "mm/dd/yy",
    	beforeShow: function(){    
           $(".ui-datepicker").css('font-size', 12) 
    	}
    });
  });

	/*TODO: Autocomplete/search, Odbieranie i ładne wypisywanie odpowiedzi, oraz rysowanie linii między punktami, geolocation
			Sobota: Autocomplete
			SetMarker powinien być na enter, po wybraniu lokalizacji.*/
	var popup;	
	window.addEventListener('WebComponentsReady', function(e){
		var map = document.getElementById("warsawMap").map;
		//Podpisz te koordy, jako boundaries np.
    	southWest = L.latLng(51.991645772197344, 20.558853149414062),
    	northEast = L.latLng(52.396134469429214, 21.430892944335938),
   		bounds = L.latLngBounds(southWest, northEast);
    	map.setMaxBounds(bounds);

    	setDate();

    	map.on('contextmenu', function(e){
    		popup = L.popup()
    		.setLatLng(e.latlng)
    		.setContent("<div onClick=\"setMarkerFromClick\(\'start\'\)\">Przystanek startowy</div><div onClick=\"setMarkerFromClick\(\'stop\'\)\">Przystanek docelowy</div>")
    		popup.openOn(map);
    	});
	}),
	
	window.setMarkerFromClick = function(id){
		var latlng = popup.getLatLng();
		if(id === 'start'){
			document.getElementById('inputStart').value = latlng.lat + "," + latlng.lng;
		}
		else if(id === 'stop'){
			document.getElementById('inputStop').value = latlng.lat + "," + latlng.lng;
		}
		$(".leaflet-popup-close-button")[0].click();
		setMarker(id, latlng);
	}
	L.Icon.Default.imagePath = "../images";

	function setDate(){
		var today = new Date();
    	var hours = today.getHours();
    	var minutes = today.getMinutes();
		var dd = today.getDate();
		var mm = today.getMonth()+1; //January is 0!
		var yyyy = today.getFullYear();

		if(dd<10)
    		dd = '0'+ dd
		if(mm<10)
    		mm = '0' + mm
		if(minutes < 10)
			minutes = '0' + minutes;

		today = mm+'/'+dd+'/'+yyyy;
		document.getElementById('hourPicker').value = hours;
		document.getElementById('minutePicker').value = minutes;
		document.getElementById('datePicker').value = today;
	}

	function accumulateCoords(coordsArray){
		/*Wyniki z searcha trzeba by przepuszczać przez własną funkcje i wyświetlać w podpwoeidziach do inputu, przy kliknięciu uruchamiać geocoder i rysować marker, a dopiero przy kliknięciu guzika szukać trasy, + przesuwanie i ustawianie markera za pomocą myszy.
		Czyli:
		1. Implementacja searcha i funkcji do któej zbiera wyniki
		2. wyświetlanie wyników w podpowiedziach przy 'inpucie' i wyswiettla w panelu

		geosearch limitowany/priorytyzowany dla konkretnej lokacji to jest must.*/
	 	setMarker("start", coordsArray[0].coords);
	  	setMarker("stop", coordsArray[1].coords);
	 
	 	sendToOTP(coordsArray);	
	}

	function sendToOTP(start_stopCoords){	
		var arriveBy = (document.getElementById('selection').selected === "Departure") ? 'false' : 'true';
		var maxWalkDistance = document.getElementById('maxWalk').value;
		var date = document.getElementById('datePicker').value;
		var hours = document.getElementById('hourPicker').value; 
		var suffix = (hours >= 12)? 'pm' : 'am';
		
		date = date.replace(/\//g,"-");
		hours = ((parseInt(hours)+11)%12)+1;
		
		var time = hours + ":" + document.getElementById('minutePicker').value + suffix;

		var requestString = "http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=" + start_stopCoords[0].coords.lat + "," + start_stopCoords[0].coords.lng + "&toPlace=" + start_stopCoords[1].coords.lat + "," + start_stopCoords[1].coords.lng + "&time=" + time + "&date=" + date + "&mode=TRANSIT,WALK&maxWalkDistance=" + maxWalkDistance + "&arriveBy=" + arriveBy + "&wheelchair=false&locale=en";
		console.log(requestString);
		var respone;
    	var reqHandler = new XMLHttpRequest();

 		reqHandler.addEventListener("load", processRequest);
    	//reqHandler.open('GET',requestString , true);
    	//reqHandler.send();

    	function processRequest(e){
    		if(reqHandler.status == 200){
  				//respone = JSON.parse(reqHandler.responseText);  	
  				console.log(reqHandler.responseXML);		
  			}
		}
	}

	var markers ={};
	function setMarker(id, latLng){
		if(markers[id] != null)
			markers[id].setLatLng(latLng);
		else{
			var marker;
			if(id === 'start'){
				var startIcon = new L.Icon({iconUrl: '../images/starterMarker.png', iconSize: [38, 35]});
				marker = new L.marker(latLng, {id:id, icon:startIcon, draggable:'true'});
				markers[id] = marker;
				marker.on('dragend', function(){
					var markerCoords = markers['start'].getLatLng();
					document.getElementById('inputStart').value = markerCoords.lat + "," + markerCoords.lng;
				});
			}
			else if(id === 'stop'){
				marker = new L.marker(latLng, {id:id, draggable:'true'});
				markers[id] = marker;
				marker.on('dragend', function(){
					var markerCoords = markers['stop'].getLatLng();
					document.getElementById('inputStop').value = markerCoords.lat + "," + markerCoords.lng;
				});
			}
			var parent = document.getElementById('warsawMap').map;
			parent.addLayer(marker);
		}
	}

/*
DEBUG STRING:
"http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=52.24188683382461,20.994014739990234&toPlace=52.19508676858302,21.002769470214844&time=2:44pm&date=02-04-2016&mode=TRANSIT,WALK&maxWalkDistance=804.672&arriveBy=false&wheelchair=false&locale=en"

http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=52.1836118,20.9790984&toPlace=52.2458726,20.9402570333431&time=2:44pm&date=02-04-2016&mode=TRANSIT,WALK&maxWalkDistance=804.672&arriveBy=false&wheelchair=false&locale=en
*/	
</script>
</dom-module>
