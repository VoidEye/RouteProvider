<!DOCTYPE html>
<html>
<head>
	<link href="../bower_components/polymer/polymer.html" rel="import">
	<link href="../bower_components/paper-drawer-panel/paper-drawer-panel.html" rel="import">
	<link href="../bower_components/paper-header-panel/paper-header-panel.html" rel="import">
	<link href="../bower_components/paper-toolbar/paper-toolbar.html" rel="import">
	<link href="../bower_components/paper-icon-button/paper-icon-button.html" rel="import">
	<link href="../bower_components/paper-material/paper-material.html" rel="import">
	<link href="../bower_components/paper-menu/paper-menu.html" rel="import">	
	<link href="../bower_components/paper-item/paper-item.html" rel="import">
	<link href="../bower_components/paper-input/paper-input.html" rel="import">
	<link href="../bower_components/paper-fab/paper-fab.html" rel="import">
	<link href="../bower_components/paper-button/paper-button.html" rel="import">
	<link href="../bower_components/iron-icons/iron-icons.html" rel="import">
	<link href="../bower_components/paper-card/paper-card.html" rel="import">
	<link href="../bower_components/google-map/google-map.html" rel="import">
	<link href="../bower_components/iron-signals/iron-signals.html" rel="import">
	

	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="//code.jquery.com/jquery-2.2.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

	<link rel="stylesheet" href="../leaflet/leaflet.css" />
	<script src="../leaflet/leaflet.js"></script>
	<script src="../leaflet/leaflet-src.js"></script>

	<link rel="stylesheet" href="../ControlGeoCoder/Control.Geocoder.css" />
	<script src="../ControlGeoCoder/Control.Geocoder.js"></script>
	<link href="journey-table.html" rel="import">

</head>

<dom-module id="route-finder">
	<style>
		#mainTopPanel {
			overflow: none;
			min-height: 100px;
		}
		.oneJourney{
			float: left;
			width: 350px;
		}
		.mainButton{
			width: 40px;
			height: 30px;
			float: right;
		}
		.jTableBtns{
			background-color: grey;
			height: 25px;
			min-width: 35px;
			padding: 0px;
			float: right;
		}
		.clearfix:after {
			content: "";
			display: table;
			clear: both;
		}
		paper-header-panel{
			color: black;
			background: #C7EDFF;
			width: 100%;
			overflow: visible;
			min-height: 200px;
			height: auto;
		}
		paper-drawer-panel{
			position: relative;
			--paper-drawer-panel-main-container: {
				background-color: C7EDFF;
			};
			--paper-drawer-panel-left-drawer-container: {
				background-color: #91DBFF;
			};
		}
	</style>
  
	<template>
		<paper-header-panel class="clearfix">
			<div id="jouTables">
			<!--<div id="mainTopPanel" class="paper-header">-->
				<template id="journeyTableT" is="dom-repeat" items="{{jTables}}">
					<div class="oneJourney">	
						<journey-table id="{{item.htmlID}}" datepickerid="{{item.dpID}}"></journey-table>
						<paper-fab id="{{item.mainButtonID}}" icon="icons:reply" on-click="forwardRequest" journey-number$="{{item.num}}" class="mainButton"></paper-fab>
					</div>
				</template>
			</div>
				<div id="addTableDiv">
					<paper-button raised id="journeyAdder" class="jTableBtns" on-click="addTable"> 
    					<iron-icon id"addStepIcon" icon="add"></iron-icon></paper-button>
    				<paper-button raised id="journeyRemove" class="jTableBtns" on-click="removeTable"> 
    					<iron-icon id="addStepIcon" icon="block"></iron-icon></paper-button>
				</div>
			<!--</div>-->    					
		</paper-header-panel>
		<paper-drawer-panel>
			<div drawer>
				<paper-card heading="Card Title">
 	 				<div class="card-content">Some content</div>
  					<div class="card-actions">
    					<paper-button>Some action</paper-button>
  					</div>
				</paper-card>
				<paper-card heading="Card Title">
  					<div class="card-content">Some content</div>

  					<div class="card-actions">
    					<paper-button>Some action</paper-button>
  					</div>
				</paper-card>
			</div>
			<div main>
				<google-map api-key="AIzaSyDaDW6auCLExulkcDpkRveDXXIr6dP6t_Y" id="warsawMap" latitude="52.2297" longitude="21.0122" zoom="12" click-events="true" mouse-events="true"></google-map>
			</div>
		</paper-drawer-panel> 
		<iron-signals on-iron-signal-inputadded="initAutoComplete"></iron-signals>
		<iron-signals on-iron-signal-inputremoved="hideMarker"></iron-signals>
	</template>

<script>
  Polymer({
    is: "route-finder",

    properties: {
    	jTables: {
    		type: Array,
    		value:[ {htmlID: "jTid0", num:  0, mainButtonID: "mB0", dpID: "datePicker0"}]
    	},
    	infWind:{
    		type: Object,
    		value: function(){return {};}
    	},
    	markers:{
    		type: Object,
    		value: function(){return {};}
    	}	
    },
    addTable: function(){
    	var lastItem = this.jTables[this.jTables.length-1];
    	lastItem = 1 + lastItem.num;
    	var newID = "jTid" + lastItem;
    	var newBID = "mB" + lastItem;
    	var newdpID = "datePicker" + lastItem;
    	this.push('jTables', {htmlID: newID ,num: lastItem, mainButtonID: newBID, dpID: newdpID});
    },
    removeTable: function(){
    	if(this.jTables.length > 1)
    		this.pop('jTables');
    },
    forwardRequest: function(e){
    	var geocoder = new L.Control.Geocoder.Nominatim();
    	if(e.target.id === "icon")
    		var jNumber = e.target.parentNode.getAttribute('journey-number');
    	else
    		var jNumber = e.target.getAttribute('journey-number');

    	var chTabID = "jTid" + jNumber;
    	var choosenTab = document.getElementById(chTabID);
    	var inputs = choosenTab.getInputs(); 
    	var coordsDict = {};

		for(i = 0; i < inputs.length; ++i){
    		if (/[a-z]/i.test(inputs[i]) === true){
    			key = chTabID + inputs[i].id;
    			coordsDict[i] = this.markers[key].position;
    		}
    	}
    	var jsonArr = [];
		sendToOTP(coordsDict ,jsonArr ,choosenTab);
    	/*
    	for(i = 0; i < inputs.length; ++i){
    		var inputAdress = inputs[i];	

	 		if (/[a-z]/i.test(inputAdress) === true){
    			geocoder.geocode(inputAdress, accCoordsWrapper(i, coordsDict, choosenTab));
    		}
    		else{
    			var cordsArr = inputAdress.split(",");
    			var toPass = [];
    				toPass[0] = {
    				name: "",
    				center: L.latLng(cordsArr[0], cordsArr[1])
    			}
    			accCoordsWrapper(toPass);
    		}	
	 	}
		
	 	function accCoordsWrapper(key, coordsDict, pChoosenTab) {
	 		function accCoordsInner(results) {
		 		var latLng = new L.LatLng(results[0].center.lat, results[0].center.lng);
	       		var startName = results[0].name;
		 		coordsDict[key] = {latLng};
		 		if(Object.keys(coordsDict).length === inputs.length)
		 		{
		 			var jsonArr = [];
		 			sendToOTP(coordsDict ,jsonArr ,pChoosenTab);
		 		}
		 	}	
		 	return accCoordsInner;
	 	}
	 	*/
    },

	/*{	przy kliknięciu guzika szukać trasy
		Czyli:
		Dać możliwość wprowadzania koordynatorów zamiast nazw
	},*/
	setMarker: function(adress, key, fromPopUp){
		if(this.markers[key] === undefined)
	    {
	    	var marker = new google.maps.Marker({
	    		draggable: true,
	    		position: {lat: 0, lng: 0}}); 
	    	this.markers[key] = marker;
	    	this.markers[key].addListener('dragend',function(e) {
	    		 console.log(e.latLng.lat());
	    	});
	    }

		var map = document.querySelector('google-map').map;
		this.markers[key].setMap(map);

		if(!fromPopUp)
			this.markers[key].setPosition(adress.geometry.location);
		else
			this.markers[key].setPosition(adress);
	},
	hideMarker: function(passedInput){
		console.log(passedInput.detail);
		if(passedInput[0] != undefined)
		{
			console.log("adf");
			var key = passedInput.detail.parentNode.parentNode.parentNode.parentNode.id + passedInput.detail.id;

			markers[key].setMap(null);
		}
	},
	printResults: function(jResp){
		//var d = new Date(0);
		//d.setUTCSeconds(journeyDate);
		var startStop = jResp.plan.from.name;
		var endStop = jResp.plan.to.name;

		for(i = 0; i < jResp.plan.itineraries.length; ++i){
			//pack all variables in some div/PolymerObject?
			//So I could pre-define polymer-element,
			//Call on it upon button press
			//Fill it with variables upn reciving an answer.
			//To do this, I need to know what kind, and how many variables there will be.
			/*
			* Tworzyć za pomocą dom-ifa karty/nagłówki
			* Karto-nagłówki winny być osobnymi polymero-elementami
			* Pakowanie danych do tych elementów: Przesłać obiekt z danymi z tej funkcji
			* Np. funkcja 'setParametres' która przyjmuje obiekt i później wszystko ładnie uzupełnia.
			* Okej, to na dom-if potrzebna jest zmienna, Czy da się ją ustawiać spoza polymerowego scopa?
			* Czy da się wywołać funkcje(tą) spoza polymero-scopa do elementu w dom-if? 
			*/
			var travelDuration = jResp.plan.itineraries[i].duration;
			var travelTimeEnd = jResp.plan.itineraries[i].endTime;
			var travelTImeBegin = jResp.plan.itineraries[i].startTime;
			var transfers = jResp.plan.itineraries[i].transfers;
			var transitTime = jResp.plan.itineraries[i].transitTime;
			var waitingTime = jResp.plan.itineraries[i].waitingTime;
			var approxWalkTime = jResp.plan.itineraries[i].walkTime;
			var walkDistance = jResp.plan.itineraries[i].walkDistance;
			
			for(j = 0; j < jResp.plan.itineraries[i].legs.length; ++j){
				var phaseDistance = jResp.plan.itineraries[i].legs[j].distance;
				var phaseTime = jResp.plan.itineraries[i].legs[j].duraton;
				var phaseEndTime = jResp.plan.itineraries[i].legs[j].endTime;
				var phaseStartTime = jResp.plan.itineraries[i].legs[j].startTime;
				var route = jResp.plan.itineraries[i].legs[j].route;
				var routeLongName = jResp.plan.itineraries[i].legs[j].routeLongName;
				var mode = jResp.plan.itineraries[i].legs[j].mode;
				var from = jResp.plan.itineraries[i].legs[j].from.name;
				var fArrival = jResp.plan.itineraries[i].legs[j].from.arrival;
				var fDeparture = jResp.plan.itineraries[i].legs[j].from.departure;
				var fStopLat = jResp.plan.itineraries[i].legs[j].from.lat;
				var fStopLng = jResp.plan.itineraries[i].legs[j].from.lon;
				var to = jResp.plan.itineraries[i].legs[j].to.name;
				var toArrival = jResp.plan.itineraries[i].legs[j].to.arrival;
				var toDeparture = jResp.plan.itineraries[i].legs[j].to.departure;
				var toStopLat = jResp.plan.itineraries[i].legs[j].to.lat;
				var toStopLng = jResp.plan.itineraries[i].legs[j].to.lon;
				console.log(from + " i= " + i + " j= " + j); 
			}
		}	
	},
	setPopUp: function(e){
		if(this.infWind === undefined ){
			this.infWind = new google.maps.InfoWindow;
			document.querySelector("route-finder").infWind = this.infWind;
		}
		var map = document.querySelector('google-map').map;

		var contentString = '';
		var jTabLen = document.querySelector("route-finder").jTables.length;
		
		for(i = 0; i < jTabLen; ++i)
		{
			contentString += "<button type=\"button\" id=\"journeyLine\" onclick=\"passTable("+i+")\">Trasa " + i;
		}
		this.infWind.setContent(contentString);
        this.infWind.setPosition(e.detail.latLng);
        this.infWind.open(map, this);        
	},
	setIwindowContent: function(tableNum){
		var contentLine = "";
		var chTabID = "jTid" + tableNum;
    	var choosenTab = document.getElementById(chTabID);
    	var inputs = choosenTab.getInputs(); 
		for(i = 0; i < inputs.length; ++i)
		{
			contentLine += "<button type=\"button\" id=\"lineForInput" + i + "\" onclick=\"passToSetMarker(" + tableNum +  ", " + i + ")\">Przystanek: " + i;
		}
		this.infWind.setContent(contentLine);
	},
	ready: function(e){
		var map = this.$.warsawMap;	
		map.addEventListener('google-map-rightclick', this.setPopUp);
		this.addEventListener('google-map-ready', this.initBasicAutoComp);
	},
	initAutoComplete: function(passedInput){
		var defaultBounds = new google.maps.LatLngBounds(
 	 			new google.maps.LatLng(51.991645772197344, 20.558853149414062),
  				new google.maps.LatLng(52.396134469429214, 21.430892944335938));

	    	var options = {
	    		bounds: defaultBounds
	    	};
	    	var key = passedInput.detail.parentNode.parentNode.parentNode.parentNode.id + passedInput.detail.id;

			var autocomplete = new google.maps.places.Autocomplete(passedInput.detail, options);

			autocomplete.addListener('place_changed',function(){
	    		place = autocomplete.getPlace();
	    		document.querySelector('route-finder').setMarker(place, key, false);
	    	});
	},
	initBasicAutoComp: function(){
			var defaultBounds = new google.maps.LatLngBounds(
	 	 			new google.maps.LatLng(51.991645772197344, 20.558853149414062),
	  				new google.maps.LatLng(52.396134469429214, 21.430892944335938));

		    var options = {
		    	bounds: defaultBounds
		    };
		    var inputs = document.getElementById('jTid0').getInputs();
	    	var autocomplete = new google.maps.places.Autocomplete(inputs[0], options);
	    	var autocomplete1 = new google.maps.places.Autocomplete(inputs[1],options);

	    	var key1 = inputs[0].parentNode.parentNode.parentNode.parentNode.id +inputs[0].id;
	    	var key2 = inputs[1].parentNode.parentNode.parentNode.parentNode.id +inputs[1].id;

	    	autocomplete.addListener('place_changed', function(){
	    		place = autocomplete.getPlace();
	    		document.querySelector('route-finder').setMarker(place, key1, false);
	    	});
	    	autocomplete1.addListener('place_changed', function(){
	    		place = autocomplete1.getPlace();
	    		document.querySelector('route-finder').setMarker(place, key2, false);
	    	});
  	},
  });
	/*TODO: Odbieranie i ładne wypisywanie odpowiedzi, oraz rysowanie linii między punktami, geolocation
			SetMarker powinien być na enter, po wybraniu lokalizacji.*/
	//L.Icon.Default.imagePath = "../images"; 		
	function passTable(passedTable){
		document.querySelector("route-finder").setIwindowContent(passedTable);
	}
	function passToSetMarker(tableNum, inputNum){
		rFinder = document.querySelector("route-finder");
		var key = "jTid" + tableNum + "inputStop" + inputNum;
		rFinder.setMarker(rFinder.infWind.position, key, true);
		rFinder.infWind.close();
	}
	function sendToOTP(coordsDict, jsonArr, jTable){	
		var jOptions = jTable.getOptions();
		var requestString = "http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=" + coordsDict[0].lat() + "," + coordsDict[0].lng() + "&toPlace=" + coordsDict[1].lat() + "," + coordsDict[1].lng() + "&time=" + jOptions["time"] + "&date=" + jOptions["date"] + "&mode=TRANSIT,WALK&maxWalkDistance=" + jOptions["maxWalk"] + "&arriveBy=" + jOptions["arriveBy"] + "&wheelchair=false&locale=en";
		console.log(requestString);
		var response;
    	var reqHandler = new XMLHttpRequest();

 		reqHandler.addEventListener("load", processRequest(coordsDict, jsonArr, jTable));
    	reqHandler.open('GET', requestString, true);
    	reqHandler.send();

    	function processRequest(passedDict, respJSONArr, jTable){
    		console.log(reqHandler.status);
    		if(reqHandler.status === 200){
    			console.log("here?");
  				response = JSON.parse(reqHandler.responseText); 
  				respJSONArr.push(respone);

  				var dictLen = Object.keys(passedDict).length;
  				if(dictLen > 2){
  					for(i = 0; i < dictLen-2; ++i)
  						passedDict[i] = passedDict[i+1]
  						
  					delete passedDict[dictLen-1];
  					SendToOTP(passedDict, respJSONArr, jTable);
  				}
  				else{
  					//setLines(respJSONArr);
  					printResults(respJSONArr);
  				}
  				console.log(response);
  			}
		}
	}
/*
	marker o różnym kolorze w zależności od j-table, ikona markera z cyfrą odpowiadającą inputowi.
	uaktualnianie koodrynatorów
*/


/*
DEBUG STRING:

http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=52.1836118,20.9790984&toPlace=52.2458726,20.9402570333431&time=2:44pm&date=02-04-2016&mode=TRANSIT,WALK&maxWalkDistance=804.672&arriveBy=false&wheelchair=false&locale=en
*/	
</script>
</dom-module>
