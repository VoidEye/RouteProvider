<!DOCTYPE html>
<head>
	<link href="../bower_components/polymer/polymer.html" rel="import">
	<link href="../bower_components/paper-drawer-panel/paper-drawer-panel.html" rel="import">
	<link href="../bower_components/paper-header-panel/paper-header-panel.html" rel="import">
	<link href="../bower_components/paper-toolbar/paper-toolbar.html" rel="import">
	<link href="../bower_components/paper-icon-button/paper-icon-button.html" rel="import">
	<link href="../bower_components/paper-material/paper-material.html" rel="import">
	<link href="../bower_components/paper-menu/paper-menu.html" rel="import">	
	<link href="../bower_components/paper-item/paper-item.html" rel="import">
	<link href="../bower_components/paper-input/paper-input.html" rel="import">
	<link href="../bower_components/paper-fab/paper-fab.html" rel="import">
	<link href="../bower_components/paper-button/paper-button.html" rel="import">
	<link href="../bower_components/iron-icons/iron-icons.html" rel="import">
	<link href="../bower_components/paper-card/paper-card.html" rel="import">
	<link href="../bower_components/google-map/google-map.html" rel="import">
	<link href="../bower_components/iron-signals/iron-signals.html" rel="import">
	<link href="../bower_components/iron-collapse/iron-collapse.html" rel="import">
	<link rel="import" href="../bower_components/iron-icons/maps-icons.html">

	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<script src="//code.jquery.com/jquery-2.2.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<link href="answer-card.html" rel="import">
	<link href="journey-table.html" rel="import">

</head>

<dom-module id="route-finder">
	<style>
		#mainTopPanel {
			overflow: none;
			min-height: 100px;
		}
		.oneJourney{
			position: relative;
			float: left;
			width: 350px;
		}
		.mainButton{
			position: absolute;
			top: 85px;
			right: 15px;
			width: 40px;
			height: 30px;
		}
		.jTableBtns{
			background-color: grey;
			height: 25px;
			min-width: 35px;
			padding: 0px;
			float: right;
		}
		.clearfix:after {
			content: "";
			display: table;
			clear: both;
		}
		#jTid0{
			--bckClr: red;

		}
		#jTid1{
			--bckClr: green;

		}
		#jTid2{
			--bckClr: blue;
		}
		#geoLocBtn{
			color: blue;
		}
		.jTabC{
			position: relative;
			top: 0;
			left: 0;
		}
      	.heading {
        	padding: 10px 15px;
        	background-color: #f3f3f3;
        	border: 1px solid #dedede;
	        border-top-left-radius: 5px;
        	border-top-right-radius: 5px;
        	font-size: 14px;
        	cursor: pointer;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        	width: 100%;
        	text-align: left;
      	}
		paper-header-panel{
			color: black;
			background: #C7EDFF;
			width: 100%;
			overflow: visible;
			min-height: 200px;
			height: auto;
		}
		paper-drawer-panel{
			position: relative;
			--paper-drawer-panel-main-container: {
				background-color: C7EDFF;
			};
			--paper-drawer-panel-left-drawer-container: {
				background-color: #91DBFF;
			};
		}
	</style>
  
	<template>
		<paper-header-panel class="clearfix">
			<div id="jouTables">
			<!--<div id="mainTopPanel" class="paper-header">-->
				<template id="journeyTableT" is="dom-repeat" items="{{jTables}}">
					<div class="oneJourney">	
						<journey-table id="{{item.htmlID}}" datepickerid="{{item.dpID}}" class="jTabC"></journey-table>
						<paper-icon-button icon="maps:my-location" id="geoLocBtn"  on-click="geoLocate" journey-number$="{{item.num}}">
						</paper-icon-button>
						<paper-fab id="{{item.mainButtonID}}" icon="icons:reply" on-click="forwardRequest" journey-number$="{{item.num}}" class="mainButton">
						</paper-fab>
					</div>
				</template>
			</div>
				<div id="addTableDiv">
					<paper-button raised id="journeyAdder" class="jTableBtns" on-click="addTable"> 
    					<iron-icon id"addStepIcon" icon="add"></iron-icon></paper-button>
    				<paper-button raised id="journeyRemove" class="jTableBtns" on-click="removeTable"> 
    					<iron-icon id="addStepIcon" icon="block"></iron-icon></paper-button>
				</div>
			<!--</div>-->    					
		</paper-header-panel>
		<paper-drawer-panel drawer-width="400px">
			<template is="dom-if" if="{{responseParsed}}">
			<div drawer>
				<template is="dom-repeat" items="{{passToAnswerArr}}">
					<button on-click="toggle" class="heading" j-num$="{{item.num}}">From: {{item.from}} To: {{item.to}}</button>
					<iron-collapse id="collapse{{item.num}}">
  						<div><answer-card></answer-card></div>
					</iron-collapse>
				</template>
			</template>
			<div main>
				<google-map api-key="AIzaSyDaDW6auCLExulkcDpkRveDXXIr6dP6t_Y" id="warsawMap" latitude="52.2297" longitude="21.0122" zoom="12" click-events="true" mouse-events="true"></google-map>
			</div>
		</paper-drawer-panel> 
		<iron-signals on-iron-signal-inputadded="initAutoComplete"></iron-signals>
		<iron-signals on-iron-signal-inputremoved="hideMarker"></iron-signals>
		<iron-signals on-iron-signal-heightchanged="adjustHeights"></iron-signals>
		<iron-signals on-iron-signal-inputsswapped="swapMarkers"></iron-signals>
	</template>

<script>
  Polymer({
    is: "route-finder",

    properties: {
    	jTables: {
    		type: Array,
    		value:[ {htmlID: "jTid0", num:  0, mainButtonID: "mB0", dpID: "datePicker0"}]
    	},
    	infWind:{
    		type: Object,
    		value: function(){return {};}
    	},
    	markers:{
    		type: Object,
    		value: function(){return {};}
    	},
    	responseParsed:{
    		type: Boolean,
    		value: true
    	},
    	numOfTransfers:{
    		type: Object,
    		value: function(){return{};}// Transfers for every Route passed from server.
    	},
    	passToAnswerArr:{
    		type: Array,
    		value: [{from: "Atlantyda", to:"Wiejska", num: 1},{from: "Wiejska", to:"Księżyc", num: 2}]
    	}	
    },
    addTable: function(){
    	if(this.jTables.length < 3)
    	{
	    	var lastItem = this.jTables[this.jTables.length-1];
	    	lastItem = 1 + lastItem.num;
	    	var newID = "jTid" + lastItem;
	    	var newBID = "mB" + lastItem;
	    	var newdpID = "datePicker" + lastItem;
	    	this.push('jTables', {htmlID: newID ,num: lastItem, mainButtonID: newBID, dpID: newdpID});
    	}
    },
    removeTable: function(){
    	if(this.jTables.length > 1){
    		var jTabID = this.jTables[this.jTables.length-1].htmlID;
    		var inputs = document.getElementById(jTabID).getInputs();
    		var key = {detail: ""};

    		for(i = 0; i < inputs.length; ++i){
    			key.detail = jTabID + inputs[i].id;
    			this.hideMarker(key);
    		}	
    		this.pop('jTables');
    	}
    },
    toggle: function(e){
    	var jNumber = e.target.getAttribute('j-num');
    	var cID = "#collapse" + jNumber;
    	this.$$(cID).toggle();
    },
    adjustHeights: function(){
    	var btnClassEle = document.querySelectorAll(".mainButton");
    	//console.log(btnClassEle);
    	//console.log(btnClassEle[0].style);
    	//console.log(button.style.top);// += 15;
    },
    forwardRequest: function(e){
    	if(e.target.id === "icon")
    		var jNumber = e.target.parentNode.getAttribute('journey-number');
    	else
    		var jNumber = e.target.getAttribute('journey-number');

    	var chTabID = "jTid" + jNumber;
    	var choosenTab = document.getElementById(chTabID);
    	var inputs = choosenTab.getInputs(); 
    	var coordsDict = {};

		for(i = 0; i < inputs.length; ++i){
    		if (/[a-z]/i.test(inputs[i].value) === true){
    			var key = chTabID + inputs[i].id;
    			coordsDict[i] = this.markers[key].position;
    		}
    		else{
    			var latLng = inputs[i].value.split(",");
    			coordsDict[i] = new google.maps.LatLng(latLng[0], latLng[1]);
    		}
    	}
    	var jsonArr = [];
		sendToOTP(coordsDict ,jsonArr ,choosenTab);
    },
    geoLocate: function(e){
    	if(e.target.id === "icon")
    		var jNumber = e.target.parentNode.getAttribute('journey-number');
    	else
    		var jNumber = e.target.getAttribute('journey-number');
    	var chTabID = "jTid" + jNumber;
    	var choosenTab = document.getElementById(chTabID);
    	var inputs = choosenTab.getInputs(); 

    	if (navigator.geolocation){
        	navigator.geolocation.getCurrentPosition(function(position){
        		var pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
            	key = chTabID + inputs[0].id;

            	var map = document.querySelector('google-map').map;
            	document.querySelector("route-finder").setMarker(pos, key, true, chTabID, inputs[0].id);
            	map.setCenter(pos);
        	});
      	}
      	else {
          // Browser doesn't support Geolocation
        	window.alert("Couldn't geolocate your position. You can try different browser");
      	}
    },

	setMarker: function(adress, key, fromPopUp, jTabid, inputID){
		if(this.markers[key] === undefined)
	    {
	    	var image = '../images/'+ jTabid + '/' + inputID + 'marker.png';
	    	var marker = new google.maps.Marker({
	    		draggable: true,
	    		position: {lat: 0, lng: 0},
	    		icon: image}); 
	    	this.markers[key] = marker;

	    	this.markers[key].addListener('dragend',function(e) {
	    		 var jTabInputs = document.getElementById(jTabid).getInputs();
	    		 for(i = 0; i < jTabInputs.length; ++i){
	    		 	if(jTabInputs[i].id === inputID)
	    		 		jTabInputs[i].value = e.latLng.lat() + "," + e.latLng.lng();
	    		 }
	    	});
	    }

		var map = document.querySelector('google-map').map;
		this.markers[key].setMap(map);

		if(!fromPopUp)
			this.markers[key].setPosition(adress.geometry.location);
		else{
			//Ustawianie tekstu w textboxie nie powinno tutaj być.
			var jTabInputs = document.getElementById(jTabid).getInputs();
			for(i = 0; i < jTabInputs.length; ++i){
	    		 	if(jTabInputs[i].id === inputID)
	    		 		jTabInputs[i].value = adress.lat() + "," + adress.lng();;
	    		 }
			this.markers[key].setPosition(adress);
		}
	},
	swapMarkers: function(inKeyList){
		var tmp = this.markers[inKeyList.detail[0]].position;
		this.markers[inKeyList.detail[0]].setPosition(this.markers[inKeyList.detail[1]].position);
		this.markers[inKeyList.detail[1]].setPosition(tmp);
	},
	hideMarker: function(passedKey){
		if(this.markers[passedKey.detail] != undefined)
			this.markers[passedKey.detail].setMap(null);
	},
	printResults: function(jResp){
		//var d = new Date(0);
		//d.setUTCSeconds(journeyDate);
		console.log(jResp);
		var tripCoords = {};
		var tripArr = [];

		for(i = 0; i < jResp.length; ++i){
			for(j = 0; j < jResp[i].plan.itineraries.length; ++j){
				var travelDuration = jResp[i].plan.itineraries[j].duration;
				var travelTimeEnd = jResp[i].plan.itineraries[j].endTime;
				var travelTImeBegin = jResp[i].plan.itineraries[j].startTime;
				var transfers = jResp[i].plan.itineraries[j].transfers;
				var transitTime = jResp[i].plan.itineraries[j].transitTime;
				var waitingTime = jResp[i].plan.itineraries[j].waitingTime;
				var approxWalkTime = jResp[i].plan.itineraries[j].walkTime;
				var walkDistance = jResp[i].plan.itineraries[j].walkDistance;
				
				for(k = 0; k < jResp[i].plan.itineraries[j].legs.length; ++k){
					var phaseDistance = jResp[i].plan.itineraries[j].legs[k].distance;
					var phaseTime = jResp[i].plan.itineraries[j].legs[k].duraton;
					var phaseEndTime = jResp[i].plan.itineraries[j].legs[k].endTime;
					var phaseStartTime = jResp[i].plan.itineraries[j].legs[k].startTime;
					var route = jResp[i].plan.itineraries[j].legs[k].route;
					var routeLongName = jResp[i].plan.itineraries[j].legs[k].routeLongName;
					var mode = jResp[i].plan.itineraries[j].legs[k].mode;
					var from = jResp[i].plan.itineraries[j].legs[k].from.name;
					var fArrival = jResp[i].plan.itineraries[j].legs[k].from.arrival;
					var fDeparture = jResp[i].plan.itineraries[j].legs[k].from.departure;
					var fStopLat = jResp[i].plan.itineraries[j].legs[k].from.lat;
					var fStopLng = jResp[i].plan.itineraries[j].legs[k].from.lon;
					var to = jResp[i].plan.itineraries[j].legs[k].to.name;
					var toArrival = jResp[i].plan.itineraries[j].legs[k].to.arrival;
					var toDeparture = jResp[i].plan.itineraries[j].legs[k].to.departure;
					var toStopLat = jResp[i].plan.itineraries[j].legs[k].to.lat;
					var toStopLng = jResp[i].plan.itineraries[j].legs[k].to.lon;
					//console.log(from + " i= " + i + " j= " + j + " k= " + k); 
					var singlePos = {lat: fStopLat, lng: fStopLng};
					tripCoords[k] = singlePos;
					console.log(tripCoords);
				}//Przystanki przesiadkowe w inputach bolduj, albo coś w tym stylu
			}
			tripArr.push(tripCoords);
		}

		console.log(tripArr);
		getDrawingPoints(coords);	
	},
	getDrawingPoints: function(coordsBook){
		$.get('https://roads.googleapis.com/v1/snapToRoads', {
    		interpolate: true,
    		key: "AIzaSyDaDW6auCLExulkcDpkRveDXXIr6dP6t_Y",
    		path: pathValues.join('|')
  		}, 
  		function(data){
    		processSnapToRoadResponse(data);
  		});
	},
	drawTrip: function(snappedPoints){
		var snappedPolyline = new google.maps.Polyline({
    		path: snappedCoordinates,
    		strokeColor: 'black',
    		strokeWeight: 3
  		});
		var map = document.querySelector('google-map').map;
  		snappedPolyline.setMap(map);
	},
	setPopUp: function(e){
		if(this.infWind === undefined ){
			this.infWind = new google.maps.InfoWindow;
			document.querySelector("route-finder").infWind = this.infWind;
		}
		var map = document.querySelector('google-map').map;

		var contentString = '';
		var jTabLen = document.querySelector("route-finder").jTables.length;
		
		for(i = 0; i < jTabLen; ++i)
		{
			contentString += "<button type=\"button\" id=\"journeyLine\" onclick=\"passTable("+i+")\">Trasa " + i;
		}
		this.infWind.setContent(contentString);
        this.infWind.setPosition(e.detail.latLng);
        this.infWind.open(map, this);        
	},
	setIwindowContent: function(tableNum){
		var contentLine = "";
		var chTabID = "jTid" + tableNum;
    	var choosenTab = document.getElementById(chTabID);
    	var inputs = choosenTab.getInputs(); 
		for(i = 0; i < inputs.length; ++i)
		{
			contentLine += "<button type=\"button\" id=\"lineForInput" + i + "\" onclick=\"passToSetMarker(" + tableNum +  ", " + i + ")\">Przystanek: " + i;
		}
		this.infWind.setContent(contentLine);
	},
	ready: function(e){
		var map = this.$.warsawMap;	
		map.addEventListener('google-map-rightclick', this.setPopUp);
		this.addEventListener('google-map-ready', this.initBasicAutoComp);
	},
	initAutoComplete: function(passedInput){
		var defaultBounds = new google.maps.LatLngBounds(
 	 			new google.maps.LatLng(51.991645772197344, 20.558853149414062),
  				new google.maps.LatLng(52.396134469429214, 21.430892944335938));

	    	var options = {
	    		bounds: defaultBounds
	    	};
	    	var jTabid = passedInput.detail.parentNode.parentNode.parentNode.parentNode.id;
	    	var key = jTabid + passedInput.detail.id;

			var autocomplete = new google.maps.places.Autocomplete(passedInput.detail, options);

			autocomplete.addListener('place_changed',function(){
	    		place = autocomplete.getPlace();
	    		document.querySelector('route-finder').setMarker(place, key, false, jTabid, passedInput.detail.id);
	    	});
	},
	initBasicAutoComp: function(){
			var defaultBounds = new google.maps.LatLngBounds(
	 	 			new google.maps.LatLng(51.991645772197344, 20.558853149414062),
	  				new google.maps.LatLng(52.396134469429214, 21.430892944335938));

		    var options = {
		    	bounds: defaultBounds
		    };
		    var inputs = document.getElementById('jTid0').getInputs();
	    	var autocomplete = new google.maps.places.Autocomplete(inputs[0], options);
	    	var autocomplete1 = new google.maps.places.Autocomplete(inputs[1],options);

	    	var key1 = 'jTid0' + inputs[0].id;
	    	var key2 = 'jTid0' + inputs[1].id;

	    	autocomplete.addListener('place_changed', function(){
	    		place = autocomplete.getPlace();
	    		document.querySelector('route-finder').setMarker(place, key1, false, "jTid0", inputs[0].id);
	    	});
	    	autocomplete1.addListener('place_changed', function(){
	    		place = autocomplete1.getPlace();
	    			    		document.querySelector('route-finder').setMarker(place, key2, false, "jTid0", inputs[0].id);
	    	});
  	},
  });
	/*TODO: Odbieranie i ładne wypisywanie odpowiedzi, oraz rysowanie linii między punktami, SetMarker powinien być na enter, po wybraniu lokalizacji.*/	
	function passTable(passedTable){
		document.querySelector("route-finder").setIwindowContent(passedTable);
	}
	function processGoogleSnapToRoadRespone(responeData){
		var snappedCoordinates = [];  
  		for (var i = 0; i < data.snappedPoints.length; ++i) {
    		var latlng = new google.maps.LatLng(
        		responeData.snappedPoints[i].location.latitude,
        		responeData.snappedPoints[i].location.longitude);
    		snappedCoordinates.push(latlng);
  		}
  		document.querySelector("route-finder").drawSnappedPolyline(snappedCoordinates);
	}
	function passToSetMarker(tableNum, inputNum){
		rFinder = document.querySelector("route-finder");
		var jTabid = "jTid" + tableNum;
		var input = "inputStop" + inputNum;
		var key = jTabid + input;
		rFinder.setMarker(rFinder.infWind.position, key, true, jTabid, input);
		rFinder.infWind.close();
	}
	function sendToOTP(coordsDict, jsonArr, jTable){	
		var jOptions = jTable.getOptions();
		//var requestString = "http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=" + coordsDict[0].lat() + "," + coordsDict[0].lng() + "&toPlace=" + coordsDict[1].lat() + "," + coordsDict[1].lng() + "&time=" + jOptions["time"] + "&date=" + jOptions["date"] + "&mode=TRANSIT,WALK&maxWalkDistance=" + jOptions["maxWalk"] + "&arriveBy=" + jOptions["arriveBy"] + "&wheelchair=false&locale=en";
		var requestString = "http://localhost:8080/otp/routers/default/plan?fromPlace=" + coordsDict[0].lat() + "," + coordsDict[0].lng() + "&toPlace=" + coordsDict[1].lat() + "," + coordsDict[1].lng() + "&time=" + jOptions["time"] + "&date=" + jOptions["date"] + "&mode=TRANSIT%2CWALK&maxWalkDistance=" + jOptions["maxWalk"] + "&arriveBy=" + jOptions["arriveBy"] + "&wheelchair=false&locale=en";
		console.log(requestString)

    	var reqHandler = new XMLHttpRequest();

		var handleStateChange = function (){
		   switch (reqHandler.readyState) {
		      case 0 : // UNINITIALIZED
		      case 1 : // LOADING
		      case 2 : // LOADED
		      case 3 : // INTERACTIVE
		      break;
		      case 4 : // COMPLETED
		      processRequest(coordsDict, jsonArr, jTable);
		      break;
		      default: alert("error");
		   }
		}

 		reqHandler.onreadystatechange=handleStateChange;
    	reqHandler.open('GET', requestString, true);
    	reqHandler.send();

    	function processRequest(passedDict, respJSONArr, jTable){
    		if(reqHandler.status === 200){
  				var response = JSON.parse(reqHandler.responseText); 
  				respJSONArr.push(response);

  				var dictLen = Object.keys(passedDict).length;
  				if(dictLen > 2){
  					for(i = 0; i < dictLen-1; ++i){
  						passedDict[i] = passedDict[i+1];
  					}
  						
  					delete passedDict[dictLen-1];
  					sendToOTP(passedDict, respJSONArr, jTable);
  				}
  				else{
  					//setLines(respJSONArr);
  					document.querySelector("route-finder").printResults(respJSONArr);
  				}
  			}
		}
	}
	function sendToAgnieszka(coordsDict, jTable){
		var dictLen = Object.keys(passedDict).length;
		var stringPartCoords = "";
		for(i = 0; i < dictLen; ++i){
			stringPartCoords += coordsDict[i].lat() + "," + coordsDict[i].lng() + ";" 
		}
		var requestString = "http://localhost:8080/otp/routers/default/plan?fromPlace=" + coordsDict[0].lat() + "," + coordsDict[0].lng() + "&toPlace=" + coordsDict[1].lat() + "," + coordsDict[1].lng() + "&time=" + jOptions["time"] + "&date=" + jOptions["date"] + "&mode=TRANSIT%2CWALK&maxWalkDistance=" + jOptions["maxWalk"] + "&arriveBy=" + jOptions["arriveBy"] + "&wheelchair=false&locale=en";
		console.log(requestString)

    	var reqHandler = new XMLHttpRequest();

		var handleStateChange = function (){
		   switch (reqHandler.readyState) {
		      case 0 : // UNINITIALIZED
		      case 1 : // LOADING
		      case 2 : // LOADED
		      case 3 : // INTERACTIVE
		      break;
		      case 4 : // COMPLETED
		      processRequest(coordsDict, jsonArr, jTable);
		      break;
		      default: alert("error");
		   }
		}

 		reqHandler.onreadystatechange=handleStateChange;
    	reqHandler.open('GET', requestString, true);
    	reqHandler.send();

    	function processRequest(passedDict, respJSONArr, jTable){
    		if(reqHandler.status === 200){
  					var response = JSON.parse(reqHandler.responseText); 
  					document.querySelector("route-finder").printResults(response);
  			}
		}
	}
/*
DEBUG STRING:

http://violet.temote.pl:8080/otp/routers/default/plan?fromPlace=52.1836118,20.9790984&toPlace=52.2458726,20.9402570333431&time=2:44pm&date=02-04-2016&mode=TRANSIT,WALK&maxWalkDistance=804.672&arriveBy=false&wheelchair=false&locale=en
*/	
</script>
</dom-module>
